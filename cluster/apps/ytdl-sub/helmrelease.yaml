---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: ytdl-sub
  namespace: ytdl-sub
spec:
  interval: 1h
  chart:
    spec:
      # renovate: registryUrl=https://bjw-s-labs.github.io/helm-charts
      chart: app-template
      version: 3.7.3
      sourceRef:
        kind: HelmRepository
        name: bjw-s-charts
        namespace: flux-system
  values:
    controllers:
      main:
        type: cronjob
        cronjob:
          schedule: "22 18 * * *"
          # schedule: "@daily" # enable for testing
          ttlSecondsAfterFinished: 86400

        pod:
          restartPolicy: OnFailure

        containers:
          main:
            image:
              repository: ghcr.io/jmbannon/ytdl-sub
              tag: 2025.09.27@sha256:edf4b926600cb450721b386aec657a2d9867c065076be11ffee6e483a96eeda9

            command:
              - ytdl-sub
              - --log-level
              - debug
              - -c
              - /config/config.yaml
              - sub
              - /config/subscriptions.yaml

            env:
              # http_proxy: ${HTTP_PROXY}
              # https_proxy: ${HTTP_PROXY}
              TZ: ${TIMEZONE}
              PUID: 1024
              PGID: 100

            resources:
              requests:
                cpu: 100m
                memory: 128M
              limits:
                memory: 32G

    service:
      main:
        controller: main
        enabled: false

    persistence:
      config:
        type: configMap
        name: config
        defaultMode: 0755
        globalMounts:
          - path: /config/config.yaml
            subPath: config.yaml
          - path: /config/subscriptions.yaml
            subPath: subscriptions.yaml
      library:
        type: nfs
        server: ${RACKNAS_ADDR}
        path: /volume1/media/YouTube
        globalMounts:
          - path: /library/YouTube
      tmp:
        type: emptyDir
        medium: Memory
        globalMounts:
          - path: /tmp/ytdl-sub
