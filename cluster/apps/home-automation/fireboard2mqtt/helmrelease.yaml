---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: fireboard2mqtt
  namespace: home-automation
spec:
  interval: 1h
  maxHistory: 3

  dependsOn:
  - name: mosquitto
    namespace: home-automation

  install:
    createNamespace: true
    remediation:
      retries: 3

  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3

  uninstall:
    keepHistory: false

  chart:
    spec:
      # renovate: registryUrl=https://bjw-s-labs.github.io/helm-charts
      chart: app-template
      version: 3.7.3
      sourceRef:
        kind: HelmRepository
        name: bjw-s-charts
        namespace: flux-system

  values:
    controllers:
      main:
        type: deployment
        annotations:
          reloader.stakater.com/auto: "true"
        
        pod:
          securityContext:
            runAsUser: 568
            runAsGroup: 568
            fsGroup: 568
            fsGroupChangePolicy: "OnRootMismatch"
        
        containers:
          main:
            image:
              repository: gordlea/fireboard2mqtt
              tag: 3.1.5-beta.0@sha256:b900d906b96399b4567289fe4162e34e823eb2b65a08c9aa2a7e02f070e7431a
            
            env:
              TZ: ${TIMEZONE}
              RUST_LOG: "fireboard2mqtt=debug"
              FB2MQTT_FIREBOARD_ENABLE_DRIVE: "true"
              FB2MQTT_MQTT_BASE_TOPIC: "homeassistant/fireboard2mqtt"
            
            envFrom:
              - secretRef:
                  name: fireboard2mqtt-secrets
            
            resources:
              requests:
                memory: 64Mi
                cpu: 10m
              limits:
                memory: 128Mi

    service:
      main:
        controller: main
        enabled: false
